# BGE Reranker v2 m3 API - Документация

## Описание

API-сервис для ранжирования документов по релевантности к поисковому запросу. Использует модель **BAAI/bge-reranker-v2-m3** для вычисления релевантности документов.

**Базовый URL:** `http://localhost:8009`

**Версия API:** 1.0

---

## Эндпоинты

### 1. Проверка состояния сервиса

#### `GET /health`

Проверяет работоспособность сервиса и возвращает информацию о модели и устройстве.

**Запрос:**
```http
GET /health HTTP/1.1
Host: localhost:8009
```

**Пример запроса (curl):**
```bash
curl -X GET http://localhost:8009/health
```

**Ответ:**
```json
{
  "status": "ok",
  "model": "BAAI/bge-reranker-v2-m3",
  "device": "cuda"
}
```

**Поля ответа:**
- `status` (string) - Статус сервиса, всегда `"ok"` при успешном ответе
- `model` (string) - Название используемой модели
- `device` (string) - Устройство выполнения: `"cuda"` (GPU) или `"cpu"`

**Коды ответа:**
- `200 OK` - Сервис работает нормально

---

### 2. Ранжирование документов

#### `POST /rerank`

Принимает поисковый запрос и список документов, возвращает отсортированные по релевантности результаты.

**Запрос:**
```http
POST /rerank HTTP/1.1
Host: localhost:8009
Content-Type: application/json
```

**Тело запроса (JSON):**
```json
{
  "query": "поисковый запрос",
  "passages": [
    "первый документ для ранжирования",
    "второй документ для ранжирования",
    "третий документ для ранжирования"
  ],
  "top_k": 5
}
```

**Параметры запроса:**
- `query` (string, обязательный) - Поисковый запрос
- `passages` (array[string], обязательный) - Список документов для ранжирования
  - Минимум 1 документ
  - Каждый элемент - строка с текстом документа
- `top_k` (integer, опциональный) - Количество топ-результатов для возврата
  - По умолчанию: `5`
  - Минимальное значение: `1`
  - Если `top_k` больше количества документов, возвращаются все документы

**Пример запроса (curl):**
```bash
curl -X POST http://localhost:8009/rerank \
  -H "Content-Type: application/json" \
  -d '{
    "query": "машинное обучение",
    "passages": [
      "Машинное обучение - это раздел искусственного интеллекта",
      "Python - популярный язык программирования",
      "Нейронные сети используются в глубоком обучении",
      "FastAPI - современный фреймворк для создания API"
    ],
    "top_k": 3
  }'
```

**Пример запроса (Python):**
```python
import requests

url = "http://localhost:8009/rerank"
data = {
    "query": "машинное обучение",
    "passages": [
        "Машинное обучение - это раздел искусственного интеллекта",
        "Python - популярный язык программирования",
        "Нейронные сети используются в глубоком обучении",
        "FastAPI - современный фреймворк для создания API"
    ],
    "top_k": 3
}

response = requests.post(url, json=data)
print(response.json())
```

**Успешный ответ:**
```json
{
  "results": [
    {
      "index": 0,
      "document": "Машинное обучение - это раздел искусственного интеллекта",
      "score": 8.234
    },
    {
      "index": 2,
      "document": "Нейронные сети используются в глубоком обучении",
      "score": 6.891
    },
    {
      "index": 1,
      "document": "Python - популярный язык программирования",
      "score": 2.145
    }
  ]
}
```

**Поля ответа:**
- `results` (array) - Массив результатов, отсортированных по убыванию релевантности
  - `index` (integer) - Оригинальный индекс документа в массиве `passages`
  - `document` (string) - Текст документа
  - `score` (float) - Оценка релевантности (чем выше, тем релевантнее)

**Коды ответа:**
- `200 OK` - Успешное ранжирование
- `400 Bad Request` - Ошибка валидации входных данных
  - Пустой список `passages`
  - Некорректный формат данных
- `500 Internal Server Error` - Внутренняя ошибка сервера
  - Ошибка при обработке модели
  - Несоответствие количества scores и passages

**Примеры ошибок:**

Ошибка валидации (пустой список passages):
```json
{
  "detail": "Passages list is empty"
}
```

Ошибка валидации (некорректный top_k):
```json
{
  "detail": [
    {
      "loc": ["body", "top_k"],
      "msg": "ensure this value is greater than or equal to 1",
      "type": "value_error.number.not_ge"
    }
  ]
}
```

---

## Формат данных

### Входные данные для `/rerank`

**Структура JSON:**
```json
{
  "query": "строка с поисковым запросом",
  "passages": [
    "строка с первым документом",
    "строка со вторым документом",
    "..."
  ],
  "top_k": 5
}
```

**Требования:**
- Все поля должны быть в формате JSON
- `Content-Type: application/json` обязателен
- `query` - непустая строка
- `passages` - массив строк, минимум 1 элемент
- `top_k` - целое число >= 1 (опционально, по умолчанию 5)

### Выходные данные

**Структура успешного ответа:**
```json
{
  "results": [
    {
      "index": 0,
      "document": "текст документа",
      "score": 8.234
    }
  ]
}
```

**Особенности:**
- Результаты отсортированы по убыванию `score`
- Количество результатов = `min(top_k, количество_документов)`
- `index` соответствует позиции документа в исходном массиве `passages`

---

## Примеры использования

### Пример 1: Базовое ранжирование

**Запрос:**
```bash
curl -X POST http://localhost:8009/rerank \
  -H "Content-Type: application/json" \
  -d '{
    "query": "искусственный интеллект",
    "passages": [
      "Искусственный интеллект - это технология будущего",
      "Погода сегодня солнечная",
      "AI помогает решать сложные задачи",
      "Рецепт пирога с яблоками"
    ]
  }'
```

**Ответ:**
```json
{
  "results": [
    {
      "index": 0,
      "document": "Искусственный интеллект - это технология будущего",
      "score": 9.123
    },
    {
      "index": 2,
      "document": "AI помогает решать сложные задачи",
      "score": 8.456
    },
    {
      "index": 1,
      "document": "Погода сегодня солнечная",
      "score": 1.234
    },
    {
      "index": 3,
      "document": "Рецепт пирога с яблоками",
      "score": 0.567
    }
  ]
}
```

### Пример 2: Ограничение количества результатов

**Запрос:**
```bash
curl -X POST http://localhost:8009/rerank \
  -H "Content-Type: application/json" \
  -d '{
    "query": "Python программирование",
    "passages": [
      "Python - язык программирования",
      "Java также популярен",
      "Python используется в data science",
      "C++ для системного программирования",
      "Python имеет простой синтаксис"
    ],
    "top_k": 2
  }'
```

**Ответ:**
```json
{
  "results": [
    {
      "index": 0,
      "document": "Python - язык программирования",
      "score": 9.789
    },
    {
      "index": 2,
      "document": "Python используется в data science",
      "score": 8.234
    }
  ]
}
```

### Пример 3: Использование в Python

```python
import requests
from typing import List, Dict

def rerank_documents(query: str, passages: List[str], top_k: int = 5) -> List[Dict]:
    """
    Ранжирует документы по релевантности к запросу
    
    Args:
        query: Поисковый запрос
        passages: Список документов для ранжирования
        top_k: Количество топ-результатов
    
    Returns:
        Список отсортированных результатов
    """
    url = "http://localhost:8009/rerank"
    data = {
        "query": query,
        "passages": passages,
        "top_k": top_k
    }
    
    response = requests.post(url, json=data)
    response.raise_for_status()
    return response.json()["results"]

# Использование
results = rerank_documents(
    query="машинное обучение",
    passages=[
        "Машинное обучение - подраздел AI",
        "Python популярен в ML",
        "Погода хорошая сегодня"
    ],
    top_k=2
)

for result in results:
    print(f"Score: {result['score']:.2f} - {result['document']}")
```

---

## Интерактивная документация

FastAPI автоматически генерирует интерактивную документацию:

- **Swagger UI:** http://localhost:8009/docs
- **ReDoc:** http://localhost:8009/redoc
- **OpenAPI Schema:** http://localhost:8009/openapi.json

Вы можете использовать эти интерфейсы для:
- Просмотра всех эндпоинтов
- Тестирования API напрямую из браузера
- Просмотра схем данных
- Экспорта OpenAPI спецификации

---

## Ограничения и особенности

1. **Максимальная длина текста:** Документы и запросы обрезаются до 512 токенов
2. **Производительность:** Рекомендуется использовать GPU для лучшей производительности
3. **Память:** Модель загружается в память при старте сервиса
4. **Параллелизм:** FastAPI обрабатывает запросы асинхронно

---

## Коды ошибок

| Код | Описание |
|-----|----------|
| 200 | Успешный запрос |
| 400 | Ошибка валидации входных данных |
| 500 | Внутренняя ошибка сервера |

---

## Технические детали

- **Фреймворк:** FastAPI 0.111.0
- **Модель:** BAAI/bge-reranker-v2-m3
- **Библиотека ML:** Transformers 4.40.0, PyTorch 2.4.0
- **Порт:** 8009
- **Протокол:** HTTP/1.1

---

## Поддержка

При возникновении проблем проверьте:
1. Статус сервиса через `/health`
2. Логи контейнера Docker
3. Корректность формата JSON в запросах
4. Доступность GPU (если требуется)

